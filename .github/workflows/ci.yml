name: Continuous Integration

on:
  push:
    branches:
      - master
  pull_request:

env:
  DR_INSTALL_DIR: "${{ github.workspace }}/installation"
  vcpkgResponseFile: "${{ github.workspace }}/vcpkg.txt"

# A full build matrix would vary at least the following:
#
#     - Sanitizers: enabled or disabled
#     - Build mode: debug or release
#     - Fuzzing: enabled or disabled
#     - macOS / several LTS versions of ubuntu / windows
#     - gcc 7 / clang 6.0 / clang 9 / gcc 9
#     - ninja / makefiles / visual studio solution / xcode
#
# This would be hundreds of configurations, and it would be silly to test all
# of them.  Instead, we pick a few notable points from this matrix, to try to
# maximize problem detection ability with a minimal number of configurations.
jobs:
  build1:
    name: Ubuntu 18.04 / GCC 8 / Debug
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Download vcpkg
        run: |
          ./download_vcpkg.sh
          echo "::set-env name=vcpkgGitCommitId::$(cat vcpkg_commit.txt)"
        # Restore from cache the previously built ports. If "cache miss", then provision vcpkg, install desired ports, finally cache everything for the next run.
      - name: Restore from cache and run vcpkg
        uses: lukka/run-vcpkg@v3
        with:
          # Response file stored in source control, it provides the list of ports and triplet(s).
          vcpkgArguments: '@${{ env.vcpkgResponseFile }}'
          # Location of vcpkg for the repository.
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          # Commit Id for vcpkg
          vcpkgGitCommitId: '${{ env.vcpkgGitCommitId }}'
          # Since the cache must be invalidated when content of the response file changes, let's
          # compute its hash and append this to the computed cache's key.
          appendedCacheKey: ${{ hashFiles(env.vcpkgResponseFile) }}
      - name: Configure
        run: >
          cmake
          -B build
          -DCMAKE_BUILD_TYPE=Debug
          -DCMAKE_C_COMPILER=gcc-8
          -DCMAKE_CXX_COMPILER=g++-8
          -DWARNINGS_AS_ERRORS=1
          -DCMAKE_INSTALL_PREFIX="$DR_INSTALL_DIR"
          -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
          .
      - name: Build
        run: make -C build -j "$(nproc)"

      - name: Test
        run: cd build && ctest --output-on-failure

      - name: Install
        run: |
          cmake --build build --target install
          rm -rf build

      - name: Test Install
        run: |
          cd tests/external_build
          cmake -B build \
            -DCMAKE_PREFIX_PATH="$DR_INSTALL_DIR" \
            -DCMAKE_C_COMPILER=gcc-8 \
            -DCMAKE_CXX_COMPILER=g++-8 \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            .
          cmake --build build

  build2:
    name: Ubuntu 18.04 / Clang 6.0 / Release
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Download vcpkg
        run: |
          ./download_vcpkg.sh
          echo "::set-env name=vcpkgGitCommitId::$(cat vcpkg_commit.txt)"
      - name: Restore from cache and run vcpkg
        uses: lukka/run-vcpkg@v3
        with:
          vcpkgArguments: '@${{ env.vcpkgResponseFile }}'
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          vcpkgGitCommitId: '${{ env.vcpkgGitCommitId }}'
          appendedCacheKey: ${{ hashFiles(env.vcpkgResponseFile) }}
      - name: Configure
        run: >
          cmake -B build
          -DCMAKE_BUILD_TYPE=RelWithDebInfo
          -DCMAKE_C_COMPILER=clang-6.0
          -DCMAKE_CXX_COMPILER=clang++-6.0
          -DWARNINGS_AS_ERRORS=1
          -DCMAKE_INSTALL_PREFIX="$DR_INSTALL_DIR"
          -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
          .
      - name: Build
        run: cmake --build build -j "$(nproc)"

      - name: Test
        run: cd build && ctest --output-on-failure

      - name: Install
        run: cmake --build build --target install

      - name: Test Install
        run: |
          cd tests/external_build
          cmake -B build \
            -DCMAKE_PREFIX_PATH="$DR_INSTALL_DIR" \
            -DCMAKE_C_COMPILER=clang-6.0 \
            -DCMAKE_CXX_COMPILER=clang++-6.0 \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            .
          cmake --build build

  build3:
    name: Ubuntu 20.04 / Clang 10 / Multi-Config / Fuzz / Sanitizers
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - name: Download vcpkg
        run: |
          ./download_vcpkg.sh
          echo "::set-env name=vcpkgGitCommitId::$(cat vcpkg_commit.txt)"
      - name: Restore from cache and run vcpkg
        uses: lukka/run-vcpkg@v3
        with:
          vcpkgArguments: '@${{ env.vcpkgResponseFile }}'
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          vcpkgGitCommitId: '${{ env.vcpkgGitCommitId }}'
          appendedCacheKey: ${{ hashFiles(env.vcpkgResponseFile) }}
      - name: Install Dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          sudo apt-get install ninja-build clang-10
      - name: Configure
        run: >
          cmake -B build
          -G 'Ninja Multi-Config'
          -DCMAKE_C_COMPILER=clang-10
          -DCMAKE_CXX_COMPILER=clang++-10
          -DENABLE_SANITIZERS=1
          -DENABLE_LIBFUZZER=1
          -DWARNINGS_AS_ERRORS=1
          -DCMAKE_INSTALL_PREFIX="$DR_INSTALL_DIR"
          -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
          .

      # We ought to be able to build multiple configurations without them
      # interfering.  First build debug, explicitly invoking `ninja`:
      - name: Build Debug
        run: ninja -C build -f build-Debug.ninja
      - name: Install Debug
        run: cmake --build build --target install
      - name: Test Debug Install
        run: |
          cd tests/external_build
          cmake -B build \
            -DCMAKE_PREFIX_PATH="$DR_INSTALL_DIR" \
            -DCMAKE_C_COMPILER=clang-10 \
            -DCMAKE_CXX_COMPILER=clang++-10 \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            .
          cmake --build build

      # Next, build RelWithDebInfo, using the indirect `cmake --build`
      # invocation of ninja.
      - name: Build Release
        run: cmake --build build --config RelWithDebInfo -j
      - name: Install Release
        run: cmake --build build --target install
      - name: Test Release Install
        run: |
          cd tests/external_build
          cmake -B build \
            -DCMAKE_PREFIX_PATH="$DR_INSTALL_DIR" \
            -DCMAKE_C_COMPILER=clang-10 \
            -DCMAKE_CXX_COMPILER=clang++-10 \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            .
          cmake --build build

      - name: Test Release
        run: cd build && ctest -C RelWithDebInfo --output-on-failure

  build4:
    name: macOS 10.15 / Debug / Sanitizers
    runs-on: macos-10.15
    steps:
      - uses: actions/checkout@v2
      - name: Download vcpkg
        run: |
          ./download_vcpkg.sh
          echo "::set-env name=vcpkgGitCommitId::$(cat vcpkg_commit.txt)"
      - name: Restore from cache and run vcpkg
        uses: lukka/run-vcpkg@v3
        with:
          vcpkgArguments: '@${{ env.vcpkgResponseFile }}'
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          vcpkgGitCommitId: '${{ env.vcpkgGitCommitId }}'
          appendedCacheKey: ${{ hashFiles(env.vcpkgResponseFile) }}
      - name: Configure
        run: >
          cmake
          -B build
          -G Xcode
          -DENABLE_SANITIZERS=1
          -DWARNINGS_AS_ERRORS=1
          -DCMAKE_INSTALL_PREFIX="$DR_INSTALL_DIR"
          -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
          .
      - name: Build
        run: cmake --build build --config Debug -j "$(sysctl -n hw.ncpu)"

      - name: Test
        run: cd build && ctest --output-on-failure

      - name: Install
        run: cmake --build build --target install

      - name: Test Install
        run: |
          cd tests/external_build
          cmake -B build -G Xcode -DCMAKE_PREFIX_PATH="$DR_INSTALL_DIR" -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" .
          cmake --build build

  build5:
    name: Windows Server 2019 / Debug
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v2
      - name: Download vcpkg
        run: |
          ./download_vcpkg.bat
          echo "::set-env name=vcpkgGitCommitId::$(cat vcpkg_commit.txt)"
      - name: Restore from cache and run vcpkg
        uses: lukka/run-vcpkg@v3
        with:
          vcpkgArguments: '@${{ env.vcpkgResponseFile }}'
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          vcpkgTriplet: 'x64-windows'
          vcpkgGitCommitId: '${{ env.vcpkgGitCommitId }}'
          appendedCacheKey: ${{ hashFiles(env.vcpkgResponseFile) }}
      - name: Configure
        run: >
          cmake
          -B build
          -G "Visual Studio 16 2019"
          -DWARNINGS_AS_ERRORS=0
          -DCMAKE_INSTALL_PREFIX="$env:DR_INSTALL_DIR"
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake"
          .
      - name: Build
        run: cmake --build build --config Debug -j

      - name: Test
        run: cd build && ctest --output-on-failure

      - name: Install
        run: cmake --build build --target install

      - name: Test Install
        run: |
          cd tests/external_build
          cmake -B build -DCMAKE_PREFIX_PATH="$env:DR_INSTALL_DIR" -G "Visual Studio 16 2019" -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" .
          cmake --build build

  build6:
    name: Ubuntu 18.04 / Clang 8 / Release / Tests Disabled
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Download vcpkg
        run: |
          ./download_vcpkg.bat
          echo "::set-env name=vcpkgGitCommitId::$(cat vcpkg_commit.txt)"
      - name: Restore from cache and run vcpkg
        uses: lukka/run-vcpkg@v3
        with:
          vcpkgArguments: '@${{ env.vcpkgResponseFile }}'
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          vcpkgGitCommitId: '${{ env.vcpkgGitCommitId }}'
          appendedCacheKey: ${{ hashFiles(env.vcpkgResponseFile) }}
      - name: Configure
        run: >
          cmake -B build
          -DCMAKE_BUILD_TYPE=Release
          -DCMAKE_C_COMPILER=clang-8
          -DCMAKE_CXX_COMPILER=clang++-8
          -DWARNINGS_AS_ERRORS=1
          -DENABLE_TESTS=0
          -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
          .
      - name: Build
        run: make -C build -j "$(nproc)"

  build7:
    name: Docker image
    runs-on: ubuntu-latest
    env:
      DOCKER_TAG: "docker.pkg.github.com/trailofbits/drlojekyll/drlojekyll:latest"
    steps:
      - uses: actions/checkout@v2
      - name: Build Docker image
        run: |
          docker build -t "$DOCKER_TAG" --target=dist .
          # Test library copy/build here to take advantage of Docker layer
          # caching
          docker build -t drlog_lib_test --target=test_lib .
      - name: Test Docker Executable
        run: prog=join_attributes; docker run --rm -v "$(pwd):/drlog/local" -w /drlog/local "$DOCKER_TAG" -dot "${prog}.dot" -amalgamation "${prog}.amal" -o "${prog}.out" "./data/examples/${prog}.dr"
      - name: Push Docker image
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          docker login docker.pkg.github.com -u "$GH_USER" -p "$GH_TOKEN"
          docker push "$DOCKER_TAG"
        env:
          GH_USER: ${{ github.actor }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
