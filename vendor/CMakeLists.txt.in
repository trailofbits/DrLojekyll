cmake_minimum_required(VERSION 3.5)

project(@GIT_DEP_NAME@ NONE)

include(ExternalProject)

set(@GIT_DEP_NAME@_FETCH_BASE_DIR "@CMAKE_BINARY_DIR@/_deps" CACHE PATH "Directory under which to collect all populated content")

ExternalProject_Add(@GIT_DEP_NAME@_project
  TMP_DIR      "${@GIT_DEP_NAME@_FETCH_BASE_DIR}/@NAME_LOWER@-tmp"
  STAMP_DIR    "${@GIT_DEP_NAME@_FETCH_BASE_DIR}/@NAME_LOWER@-stamp"
  DOWNLOAD_DIR "${@GIT_DEP_NAME@_FETCH_BASE_DIR}/@NAME_LOWER@-download"
  SOURCE_DIR   "${@GIT_DEP_NAME@_FETCH_BASE_DIR}/@NAME_LOWER@-src"
  BINARY_DIR   "${@GIT_DEP_NAME@_FETCH_BASE_DIR}/@NAME_LOWER@-build"

  GIT_REPOSITORY "@GIT_DEP_REPOSITORY@"
  
  @TAG_CMD@
  LOG_DOWNLOAD TRUE
  
  BUILD_ALWAYS FALSE
  BUILD_IN_SOURCE FALSE

  UPDATE_COMMAND ""
  LOG_UPDATE TRUE

  PATCH_COMMAND ""
  LOG_PATCH TRUE

  # CONFIGURE_COMMAND ""
  CMAKE_ARGS
    -DCMAKE_C_COMPILER=@CMAKE_C_COMPILER@
    -DCMAKE_CXX_COMPILER=@CMAKE_CXX_COMPILER@
    -DCMAKE_PREFIX_PATH=@CMAKE_CURRENT_BINARY_DIR@/install
    -DCMAKE_MODULE_PATH=@CMAKE_SOURCE_DIR@/cmake
    -DCMAKE_INSTALL_PREFIX=@CMAKE_CURRENT_BINARY_DIR@/install
    -DCMAKE_INSTALL_LIBDIR=lib
    -DCMAKE_INSTALL_INCLUDEDIR=include
    -DCMAKE_INSTALL_BINDIR=bin
    -DCMAKE_BUILD_TYPE=@CMAKE_BUILD_TYPE@
    -DCMAKE_POSITION_INDEPENDENT_CODE:BOOL=ON
    @ADDITIONAL_ARGS@
  
  @SUBDIR_CMD@
  
  LOG_CONFIGURE TRUE
  
  # BUILD_COMMAND ""
  LOG_BUILD TRUE

  # INSTALL_COMMAND ""
  LOG_INSTALL TRUE

  TEST_BEFORE_INSTALL FALSE
  TEST_AFTER_INSTALL FALSE
  TEST_COMMAND ""
  LOG_TEST FALSE
)

# Patched using PATCH_COMMAND above ends up re-running; so here we manually
# do the patching, and only do it once.
set(@GIT_DEP_NAME@_patch_cmd @GIT_DEP_PATCH_COMMAND@)
if(NOT @GIT_DEP_NAME@_patch_cmd STREQUAL "")
  ExternalProject_Add_Step(@GIT_DEP_NAME@_project yolo_patch
    COMMAND @GIT_DEP_PATCH_COMMAND@
    COMMENT "Patching @GIT_DEP_NAME@"
    ALWAYS 0
    EXCLUDE_FROM_MAIN 0
    WORKING_DIRECTORY "${@GIT_DEP_NAME@_FETCH_BASE_DIR}/@NAME_LOWER@-src"
    DEPENDEES download
    DEPENDERS patch)
endif()